# Copyright (c) 2013 Silke Horn
# http://solros.de/polymake/poly_database
# 
# This file is part of the polymake extension poly_database.
# 
# poly_database is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
# 
# poly_database is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with poly_database.  If not, see <http://www.gnu.org/licenses/>.

use Term::ReadKey;


sub get_credentials {
	# TODO: cache, key chain??
	print "user name: ";
	my $u= <STDIN>;
	ReadMode 2;
	print "password: ";
	my $p= <STDIN>;
	ReadMode 0;
	print "\n";
	chomp($u);
	chomp($p);
	return ($u,$p);
}

# @category Database
# Adds an object //obj// to the collection //col// in the database //db//. First it matches its properties with a template object //temp//.
# 
# Note that you need admin access to the database for this. You will be asked for credentials if you don't specify them.
# @param obj Core::Object
# @param String db database name
# @param String col collection name
# @param String id
# @param String contrib
# @option Bool local set to 1 if you want to use a local database (on localhost), default 0
# @option String username
# @option String password
# @return String
user_function poly_db_insert ($, $, $, $, $, {local => 0, username => "", password => ""}){
	my ($obj, $db, $col, $id, $contrib, $options) = @_;
 	
 	my $local = $options->{local};
 	my $u = $options->{username};
 	my $p = $options->{password};
	
	unless ($u) {
		my @cred = get_credentials;
		$u = $cred[0];
		$p = $cred[1];
	}
	
	my $temp = get_template_object($db, $col, $local);
#	print $temp->list_properties();
#	print "\n";
	copy_properties_db($obj, $temp);
#	print $obj->list_properties;

	my $client = get_client($local, $u, $p);	
		
	my $db = $client->get_database($db);
	my $col = $db->get_collection($col);
	my $output = $col->insert(pm2json($obj, $id, $contrib));
	return $output;
}

# @category Database
# Adds an object //obj// to the collection //col// in the database //db//. First it matches its properties with a template object //temp// (but without computing additional properties).
# 
# Note that you need admin access to the database for this. You will be asked for credentials if you don't specify them.
# @param obj Core::Object
# @param String db database name
# @param String col collection name
# @param String id
# @param String contrib
# @option Bool local set to 1 if you want to use a local database (on localhost), default 0
# @option String username
# @option String password
# @return String
user_function poly_db_fast_insert ($, $, $, $, $, {local => 0, username => "", password => ""}){
	my ($obj, $db, $col, $id, $contrib, $options) = @_;
 	
 	my $local = $options->{local};
 	my $u = $options->{username};
 	my $p = $options->{password};
 	
	unless ($u) {
		my @cred = get_credentials;
		$u = $cred[0];
		$p = $cred[1];
	}
	
	my $temp = get_template_object($db, $col, $local);
	copy_properties_nonew_db($obj, $temp);
	
	my $client = get_client($local, $u, $p);	
		
	my $db_name = $client->get_database($db);
	my $collection = $db->get_collection($col);
	my $output = $collection->insert(pm2json($obj, $id, $contrib));
	return $output;
}


# @category Database
# Adds an object //obj// to the collection //col// in the database //db// without any adaption of the properties. Only use this if you absolutely know what you're doing.
# 
# Note that you need admin access to the database for this. You will be asked for credentials if you don't specify them.
# @param obj Core::Object
# @param String db database name
# @param String col collection name
# @param String id
# @param String contrib
# @option Bool local set to 1 if you want to use a local database (on localhost), default 0
# @option String username
# @option String password
# @return String
user_function poly_db_force_insert($, $, $, $, $, {local => 0, username => "", password => ""}) {
	my ($obj, $db, $col, $id, $contrib, $options) = @_;
 	
 	my $local = $options->{local};
 	my $u = $options->{username};
 	my $p = $options->{password};

	unless ($u) {
		my @cred = get_credentials;
		$u = $cred[0];
		$p = $cred[1];
	}

	my $client = get_client($local, $u, $p);	
		
	my $db = $client->get_database($db);
	my $col = $db->get_collection($col);
	my $output = $col->insert(pm2json($obj, $id, $contrib));
	return $output;
}

user_function test_option ($, {u => 0}) {
	my $par = shift;
	my $options=shift;
	
	print $par."\n";
	my $u=$options->{u};
	if ($u) {
		print "1";
	} else {
		print "0";
	}
}
